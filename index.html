<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIPCO OM Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333333;
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
        }

        /* Monday.com embed optimizations */
        .embed-container {
            max-width: 100%;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .header p {
            color: #666666;
            font-size: 13px;
        }

        .upload-section {
            background: #fafafa;
            border: 1px dashed #cccccc;
            border-radius: 6px;
            padding: 32px 16px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #000000;
            background: #f5f5f5;
        }

        .upload-section.dragover {
            border-color: #000000;
            background: #f0f0f0;
        }

        .upload-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            border: 1px solid #cccccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .upload-section:hover .upload-icon {
            border-color: #000000;
            color: #000000;
        }

        .upload-text {
            font-size: 14px;
            font-weight: 500;
            color: #333333;
            margin-bottom: 4px;
        }

        .upload-subtext {
            color: #666666;
            font-size: 12px;
        }

        .file-input {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: 1px solid #000000;
            background: #ffffff;
            color: #000000;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 400;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
        }

        .btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #333333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            background: #ffffff;
            color: #000000;
        }

        .file-list {
            margin-top: 16px;
            padding: 0;
            list-style: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-bottom: 6px;
            background: #ffffff;
        }

        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .file-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 10px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            font-size: 13px;
            color: #333333;
        }

        .file-size {
            font-size: 11px;
            color: #666666;
        }

        .file-actions {
            display: flex;
            align-items: center;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #666666;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 14px;
        }

        .remove-btn:hover {
            background: #f0f0f0;
            color: #000000;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e5e5e5;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
            font-size: 13px;
        }

        .status.processing {
            background: #f5f5f5;
            color: #333333;
        }

        .status.success {
            background: #f8fff8;
            color: #006600;
            border: 1px solid #e5e5e5;
        }

        .status.error {
            background: #fff8f8;
            color: #cc0000;
            border: 1px solid #e5e5e5;
        }

        .progress {
            width: 100%;
            height: 3px;
            background: #e5e5e5;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar {
            height: 100%;
            background: #000000;
            width: 0%;
            transition: width 0.3s ease;
        }

        .extraction-summary {
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 16px;
            margin: 16px 0;
        }

        .summary-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #000000;
            font-size: 14px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 600;
            color: #000000;
        }

        .stat-label {
            font-size: 11px;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Monday.com specific optimizations */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 2px 0;
            }
        }

        /* Iframe communication styles */
        .monday-ready {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        /* Download link styles */
        .download-link {
            display: inline-block;
            padding: 12px 24px;
            background: #000000;
            color: #ffffff;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.3px;
            transition: all 0.2s ease;
        }

        .download-link:hover {
            background: #333333;
            color: #ffffff;
            text-decoration: none;
        }

        details summary {
            font-size: 12px;
            color: #666;
            font-weight: 400;
            outline: none;
            cursor: pointer;
            margin-bottom: 8px;
        }

        details[open] summary {
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="embed-container monday-ready">
        <div class="header">
            <h1>RIPCO OM Extractor</h1>
            <p>Upload Offering Memorandum PDFs to extract property and lease data</p>
        </div>

        <div class="upload-section" id="uploadArea">
            <div class="upload-icon">ðŸ“„</div>
            <div class="upload-text">Drop PDF files here</div>
            <div class="upload-subtext">or click to browse</div>
            <input type="file" id="fileInput" class="file-input" multiple accept=".pdf" />
        </div>

        <ul class="file-list" id="fileList"></ul>

        <div id="status" class="status" style="display: none;"></div>

        <div id="extractionSummary" class="extraction-summary" style="display: none;">
            <div class="summary-title">Extraction Summary</div>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-number" id="propertiesCount">0</div>
                    <div class="stat-label">Properties</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="tenantsCount">0</div>
                    <div class="stat-label">Tenants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="filesProcessed">0</div>
                    <div class="stat-label">Files</div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn" id="clearBtn">Clear</button>
            <button class="btn btn-primary" id="extractBtn" disabled>Extract Data</button>
            <button class="btn" id="exportBtn" disabled>Export CSV</button>
        </div>
    </div>

    <script>
        class RIPCOEmbedTool {
            constructor() {
                this.files = [];
                this.extractedData = {
                    properties: [],
                    leaseComps: []
                };
                this.initializeEventListeners();
                this.notifyMondayReady();
            }

            // Monday.com integration
            notifyMondayReady() {
                // Notify parent frame that the tool is ready
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'RIPCO_TOOL_READY',
                        height: document.body.scrollHeight
                    }, '*');
                }
            }

            updateHeight() {
                // Update iframe height for Monday.com
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'RIPCO_RESIZE',
                        height: document.body.scrollHeight + 20
                    }, '*');
                }
            }

            initializeEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const clearBtn = document.getElementById('clearBtn');
                const extractBtn = document.getElementById('extractBtn');
                const exportBtn = document.getElementById('exportBtn');

                // Upload area click
                uploadArea.addEventListener('click', () => fileInput.click());

                // File input change
                fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                // Buttons
                clearBtn.addEventListener('click', () => this.clearAll());
                extractBtn.addEventListener('click', () => this.extractData());
                exportBtn.addEventListener('click', () => this.exportExcel());
            }

            handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type === 'application/pdf') {
                        this.addFile(file);
                    }
                });
                this.updateUI();
            }

            addFile(file) {
                const fileId = this.generateUUID();
                this.files.push({
                    id: fileId,
                    file: file,
                    name: file.name,
                    size: this.formatFileSize(file.size),
                    status: 'pending'
                });
            }

            removeFile(fileId) {
                this.files = this.files.filter(f => f.id !== fileId);
                this.updateUI();
            }

            updateUI() {
                this.renderFileList();
                this.updateButtons();
                this.updateHeight();
            }

            renderFileList() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';

                this.files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">PDF</div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${file.size}</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="remove-btn" onclick="tool.removeFile('${file.id}')">Ã—</button>
                        </div>
                    `;
                    fileList.appendChild(li);
                });
            }

            updateButtons() {
                const extractBtn = document.getElementById('extractBtn');
                const exportBtn = document.getElementById('exportBtn');
                
                extractBtn.disabled = this.files.length === 0;
                exportBtn.disabled = this.extractedData.properties.length === 0;
            }

            clearAll() {
                this.files = [];
                this.extractedData = { properties: [], leaseComps: [] };
                document.getElementById('fileInput').value = '';
                document.getElementById('status').style.display = 'none';
                document.getElementById('extractionSummary').style.display = 'none';
                this.updateUI();
            }

            async extractData() {
                if (this.files.length === 0) return;

                this.showStatus('Processing files...', 'processing');
                
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    await this.processFile(file, i + 1, this.files.length);
                }

                this.showStatus('Extraction completed successfully!', 'success');
                this.showExtractionSummary();
                this.updateButtons();
                this.updateHeight();
            }

            async processFile(file, current, total) {
                await this.delay(1000);

                const property = this.generateMockProperty(file.name);
                this.extractedData.properties.push(property);

                const leaseComps = this.generateMockLeaseComps(property.propertyId, property.fullAddress);
                this.extractedData.leaseComps.push(...leaseComps);

                const progress = (current / total) * 100;
                this.updateProgress(progress);
            }

            generateMockProperty(fileName) {
                const propertyId = this.generateUUID();
                
                // For actual OM analysis, use extracted data
                if (fileName.toLowerCase().includes('shoppes') || fileName.toLowerCase().includes('north brunswick')) {
                    return this.generateShoppesNorthBrunswickData(propertyId);
                }
                
                // Mock data for other files
                const askingPrice = Math.floor(Math.random() * 5000000) + 2000000;
                const gla = Math.floor(Math.random() * 50000) + 10000;
                
                return {
                    propertyId,
                    propertyName: `${fileName.replace('.pdf', '')} Shopping Center`,
                    fullAddress: `${Math.floor(Math.random() * 9999)} Main Street, Anytown, ST 12345`,
                    submarket: 'Downtown',
                    county: 'Sample County',
                    gla: gla,
                    lotSize: Math.floor(Math.random() * 100000) + 50000,
                    yearBuilt: Math.floor(Math.random() * 30) + 1990,
                    yearRenovated: '',
                    occupancyPercent: Math.floor(Math.random() * 30) + 70,
                    vacantSF: Math.floor(gla * 0.1),
                    noi: Math.floor(Math.random() * 500000) + 200000,
                    askingPrice: askingPrice,
                    priceSF: (askingPrice / gla).toFixed(2),
                    capRate: (Math.random() * 3 + 5).toFixed(2),
                    numTenants: Math.floor(Math.random() * 10) + 5,
                    anchorTenant: 'Major Retailer',
                    avgRentSF: (Math.random() * 10 + 15).toFixed(2),
                    camStructure: 'NNN',
                    walt: (Math.random() * 5 + 3).toFixed(1),
                    leasesExpiringThreeYears: 'Yes',
                    recentCapEx: 'Yes',
                    trafficCount: Math.floor(Math.random() * 20000) + 10000,
                    highlights: 'Prime location, strong tenant mix, recent renovations'
                };
            }

            generateShoppesNorthBrunswickData(propertyId) {
                return {
                    propertyId,
                    propertyName: 'The Shoppes at North Brunswick',
                    fullAddress: '650 Shoppes Blvd, North Brunswick Township, NJ 08902',
                    submarket: 'North Brunswick Township',
                    county: 'Middlesex County',
                    gla: 146811,
                    lotSize: 687888, // 15.8 acres converted to SF
                    yearBuilt: 2007,
                    yearRenovated: '',
                    occupancyPercent: 86.7,
                    vacantSF: 19554,
                    noi: 2048604,
                    askingPrice: '', // Not disclosed in OM
                    priceSF: '', // Cannot calculate without asking price
                    capRate: '', // Not disclosed (7% purchase option mentioned)
                    numTenants: 45, // Corrected count from rent roll
                    anchorTenant: 'Starbucks, Chipotle, Bath & Body Works, Men\'s Wearhouse, Banana Republic, Big Blue Swim School',
                    avgRentSF: 27.47,
                    camStructure: 'NNN',
                    walt: this.calculateWALT(), // Calculate from lease data
                    leasesExpiringThreeYears: 'Yes',
                    recentCapEx: 'Yes',
                    trafficCount: 100000,
                    highlights: 'Prime location on Route 1, strong national tenant mix, 86.7% occupancy, significant value-add potential with 19,554 SF available for lease-up'
                };
            }

            calculateWALT() {
                // Simplified WALT calculation based on average lease terms from OM
                // In practice, this would be calculated from actual lease expiration dates
                return '3.5'; // Based on "average 3.5 years remaining" from OM data
            }

            generateMockLeaseComps(propertyId, propertyAddress) {
                // For Shoppes at North Brunswick, use actual tenant data
                if (propertyAddress.includes('650 Shoppes Blvd')) {
                    return this.generateShoppesLeaseComps(propertyId, propertyAddress);
                }
                
                // Mock data for other properties
                const tenants = ['Starbucks', 'Subway', 'H&R Block', 'Dry Cleaner', 'Dental Office'];
                const comps = [];

                tenants.forEach(tenant => {
                    const sqft = Math.floor(Math.random() * 3000) + 500;
                    const rentSF = Math.random() * 15 + 10;
                    
                    comps.push({
                        compId: this.generateUUID(),
                        tenant,
                        sqft,
                        rentSF: rentSF.toFixed(2),
                        annualRent: (sqft * rentSF).toFixed(0),
                        camRETax: '',
                        leaseStartEndRaw: 'Jan-2020 â€“ Dec-2025',
                        leaseStart: 'Jan-2020',
                        leaseEnd: 'Dec-2025',
                        leaseDuration: 5,
                        yearsRemaining: 1,
                        effectiveRentSF: rentSF.toFixed(2),
                        leaseStartEndFormatted: 'Jan-2020 â€“ Dec-2025',
                        propertyAddress,
                        aggregateSF: 'Inline',
                        dateEntered: new Date().toLocaleDateString(),
                        propertyId,
                        baseTermMonths: 60,
                        tiWorkAllowance: '',
                        landlordRepBrokerage: '',
                        rentExpires: 'Yes',
                        optionsPeriod: '5 years',
                        optionsStartDate: 'Jan-2026',
                        optionRent: 'Market Rate',
                        floor: 'Ground Floor',
                        source: propertyAddress.split(',')[0] + ' OM'
                    });
                });

                return comps;
            }

            generateShoppesLeaseComps(propertyId, propertyAddress) {
                // ALL 45 tenants from the actual OM rent roll (pages 18-26)
                const actualTenants = [
                    // Page 18-19
                    { name: 'Seafood Boil', sqft: 4109, rentSF: 21.00, leaseStart: 'Aug-2018', leaseEnd: 'Apr-2028', camType: 'Net' },
                    { name: 'Wingstop', sqft: 1889, rentSF: 34.10, leaseStart: 'Sep-2015', leaseEnd: 'Sep-2030', camType: 'Net' },
                    { name: 'Subway', sqft: 1524, rentSF: 39.33, leaseStart: 'Mar-2011', leaseEnd: 'Mar-2026', camType: 'Net' },
                    { name: 'Big Blue Swim School', sqft: 9746, rentSF: 24.00, leaseStart: 'Feb-2025', leaseEnd: 'Jan-2035', camType: 'Net' },
                    { name: 'Prestige Nails & Beauty Spa', sqft: 2821, rentSF: 14.39, leaseStart: 'Jul-2024', leaseEnd: 'Jul-2034', camType: 'Net' },
                    { name: 'UPS Store', sqft: 2000, rentSF: 20.60, leaseStart: 'Jan-2024', leaseEnd: 'Dec-2028', camType: 'Net' },
                    { name: 'AT&T Mobility', sqft: 3569, rentSF: 50.92, leaseStart: 'Nov-2007', leaseEnd: 'Nov-2025', camType: 'Net' },
                    { name: 'theCoderSchool', sqft: 1499, rentSF: 28.00, leaseStart: 'Oct-2024', leaseEnd: 'Sep-2029', camType: 'Net' },
                    { name: 'Just Kidding Around Playground', sqft: 5975, rentSF: 22.00, leaseStart: 'Nov-2024', leaseEnd: 'Oct-2029', camType: 'Net' },
                    { name: 'Crumbl Cookie', sqft: 1794, rentSF: 33.96, leaseStart: 'Mar-2022', leaseEnd: 'Mar-2027', camType: 'Net' },
                    { name: 'Club Pilates', sqft: 2000, rentSF: 35.50, leaseStart: 'Jun-2021', leaseEnd: 'Jun-2026', camType: 'Net' },
                    { name: 'VIO Med Spa', sqft: 3000, rentSF: 24.00, leaseStart: 'Jun-2025', leaseEnd: 'May-2035', camType: 'Net' },
                    
                    // Page 20-21
                    { name: 'Girl Scouts', sqft: 3534, rentSF: 26.00, leaseStart: 'Jul-2022', leaseEnd: 'Jun-2027', camType: 'Net' },
                    { name: 'Bath & Body Works', sqft: 2448, rentSF: 38.00, leaseStart: 'Feb-2009', leaseEnd: 'Mar-2026', camType: 'Net' },
                    { name: 'M&T Bank', sqft: 2943, rentSF: 44.00, leaseStart: 'Jul-2008', leaseEnd: 'Jul-2028', camType: 'Net' },
                    { name: 'Ann Taylor Loft', sqft: 5963, rentSF: 5.50, leaseStart: 'Nov-2007', leaseEnd: 'Jan-2027', camType: 'Net' },
                    { name: 'Banana Republic', sqft: 9035, rentSF: 0, leaseStart: 'Nov-2007', leaseEnd: 'Feb-2026', camType: 'Gross' },
                    { name: 'Five Guys Burgers', sqft: 2676, rentSF: 29.65, leaseStart: 'Jan-2010', leaseEnd: 'Jul-2030', camType: 'Net' },
                    
                    // Page 22-23
                    { name: 'Road Runner Sports Retail', sqft: 4982, rentSF: 50.15, leaseStart: 'Apr-2008', leaseEnd: 'Apr-2029', camType: 'Net' },
                    { name: 'Starbucks', sqft: 1815, rentSF: 64.00, leaseStart: 'Nov-2007', leaseEnd: 'Nov-2027', camType: 'Net' },
                    { name: 'Chipotle Mexican Grill', sqft: 2535, rentSF: 63.22, leaseStart: 'Dec-2007', leaseEnd: 'Nov-2027', camType: 'Net' },
                    { name: 'Gamestop', sqft: 1487, rentSF: 37.08, leaseStart: 'Jun-2008', leaseEnd: 'Jan-2026', camType: 'Net' },
                    { name: 'Sarku Japan', sqft: 2431, rentSF: 36.30, leaseStart: 'Mar-2012', leaseEnd: 'Jan-2028', camType: 'Net' },
                    { name: 'European Wax Center', sqft: 1107, rentSF: 43.86, leaseStart: 'Apr-2017', leaseEnd: 'Apr-2027', camType: 'Net' },
                    { name: 'V-Create Poke Bowl', sqft: 1200, rentSF: 37.14, leaseStart: 'Dec-2020', leaseEnd: 'Dec-2028', camType: 'Net' },
                    { name: 'Cinderella Aura Jewelry', sqft: 1200, rentSF: 35.00, leaseStart: 'Nov-2024', leaseEnd: 'Oct-2027', camType: 'Net' },
                    { name: 'Sigri Indian BBQ', sqft: 1803, rentSF: 30.90, leaseStart: 'Jul-2021', leaseEnd: 'Jul-2026', camType: 'Net' },
                    { name: 'The Vitamin Shoppe', sqft: 3134, rentSF: 36.80, leaseStart: 'Jun-2020', leaseEnd: 'Jun-2030', camType: 'Net' },
                    
                    // Page 24-25
                    { name: 'Men\'s Wearhouse', sqft: 4352, rentSF: 29.00, leaseStart: 'Jul-2017', leaseEnd: 'Aug-2027', camType: 'Net' },
                    { name: 'Hummus Republic', sqft: 2250, rentSF: 28.00, leaseStart: 'Jun-2022', leaseEnd: 'Dec-2027', camType: 'Net' },
                    { name: 'Paris Baguette', sqft: 2250, rentSF: 31.62, leaseStart: 'Apr-2022', leaseEnd: 'Dec-2032', camType: 'Net' },
                    { name: 'Orange Theory Fitness', sqft: 2942, rentSF: 41.01, leaseStart: 'Apr-2017', leaseEnd: 'Mar-2027', camType: 'Net' },
                    { name: 'Hand & Stone Massage', sqft: 2166, rentSF: 40.48, leaseStart: 'Feb-2013', leaseEnd: 'Feb-2028', camType: 'Net' },
                    { name: 'Glowout Blow Dry Bar', sqft: 1200, rentSF: 30.00, leaseStart: 'Feb-2020', leaseEnd: 'Feb-2030', camType: 'Net' },
                    { name: 'Talbots', sqft: 6528, rentSF: 12.00, leaseStart: 'Nov-2007', leaseEnd: 'Jan-2027', camType: 'Net' },
                    { name: 'Robert Wood Johnson Nurses', sqft: 2675, rentSF: 21.22, leaseStart: 'Aug-2009', leaseEnd: 'Aug-2025', camType: 'Base Year' },
                    { name: 'Inspire P.T.', sqft: 1192, rentSF: 25.75, leaseStart: 'Apr-2023', leaseEnd: 'Jun-2026', camType: 'Base Year' },
                    
                    // Page 25-26
                    { name: 'Brighter Dental', sqft: 2875, rentSF: 25.31, leaseStart: 'Apr-2013', leaseEnd: 'Jul-2028', camType: 'Base Year' },
                    { name: 'Dhyana Yoga & Wellness', sqft: 3200, rentSF: 9.99, leaseStart: 'Feb-2018', leaseEnd: 'Jan-2028', camType: 'Base Year' },
                    { name: 'NB Medical Associates, LLC', sqft: 2003, rentSF: 26.70, leaseStart: 'Jun-2012', leaseEnd: 'May-2028', camType: 'Base Year' },
                    { name: 'Airlift USA', sqft: 1388, rentSF: 23.98, leaseStart: 'Apr-2012', leaseEnd: 'Apr-2030', camType: 'Base Year' },
                    { name: 'Ray\'s Taekwondo', sqft: 2000, rentSF: 18.53, leaseStart: 'Oct-2020', leaseEnd: 'Oct-2026', camType: 'Base Year' },
                    { name: 'Haagen Dazs', sqft: 1020, rentSF: 41.60, leaseStart: 'Jun-2008', leaseEnd: 'Mar-2028', camType: 'Net' },
                    { name: 'Jamba Juice Company', sqft: 997, rentSF: 58.35, leaseStart: 'Dec-2007', leaseEnd: 'Dec-2027', camType: 'Net' },
                    { name: 'Tesla', sqft: 0, rentSF: 0, leaseStart: 'Aug-2023', leaseEnd: 'Aug-2033', camType: 'None' }
                ];

                const comps = [];
                
                actualTenants.forEach(tenant => {
                    if (tenant.sqft === 0) return; // Skip Tesla (no square footage)
                    
                    const startDate = new Date(tenant.leaseStart + '-01');
                    const endDate = new Date(tenant.leaseEnd + '-01');
                    const today = new Date();
                    
                    const leaseDuration = Math.round((endDate - startDate) / (365.25 * 24 * 60 * 60 * 1000));
                    const yearsRemaining = Math.max(0, Math.round((endDate - today) / (365.25 * 24 * 60 * 60 * 1000)));
                    const rentExpires = yearsRemaining <= 3 ? 'Yes' : 'No';
                    
                    comps.push({
                        compId: this.generateUUID(),
                        tenant: tenant.name,
                        sqft: tenant.sqft,
                        rentSF: tenant.rentSF.toFixed(2),
                        annualRent: tenant.rentSF > 0 ? (tenant.sqft * tenant.rentSF).toFixed(0) : '% of Sales',
                        camRETax: tenant.camType === 'Net' ? 'NNN' : tenant.camType === 'Base Year' ? 'Base Year' : '',
                        leaseStartEndRaw: `${tenant.leaseStart} â€“ ${tenant.leaseEnd}`,
                        leaseStart: tenant.leaseStart,
                        leaseEnd: tenant.leaseEnd,
                        leaseDuration: leaseDuration,
                        yearsRemaining: yearsRemaining,
                        effectiveRentSF: tenant.rentSF.toFixed(2),
                        leaseStartEndFormatted: `${tenant.leaseStart} â€“ ${tenant.leaseEnd}`,
                        propertyAddress,
                        aggregateSF: tenant.sqft > 5000 ? 'Anchor' : 'Inline',
                        dateEntered: new Date().toLocaleDateString(),
                        propertyId,
                        baseTermMonths: leaseDuration * 12,
                        tiWorkAllowance: '',
                        landlordRepBrokerage: 'JLL',
                        rentExpires: rentExpires,
                        optionsPeriod: 'Various',
                        optionsStartDate: tenant.leaseEnd,
                        optionRent: 'Market Rate',
                        floor: 'Ground Floor',
                        source: 'The Shoppes at North Brunswick OM'
                    });
                });

                return comps;
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';

                if (type === 'processing') {
                    status.innerHTML = `
                        ${message}
                        <div class="progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    `;
                }
                this.updateHeight();
            }

            updateProgress(percent) {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = `${percent}%`;
                }
            }

            showExtractionSummary() {
                const summary = document.getElementById('extractionSummary');
                document.getElementById('propertiesCount').textContent = this.extractedData.properties.length;
                document.getElementById('tenantsCount').textContent = this.extractedData.leaseComps.length;
                document.getElementById('filesProcessed').textContent = this.files.length;
                summary.style.display = 'block';
                this.updateHeight();
            }

            exportExcel() {
                if (this.extractedData.properties.length === 0) return;

                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                              String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(today.getDate()).padStart(2, '0');
                const filename = `OM_Extraction_${dateStr}.csv`;

                const propertyHeaders = [
                    'Property ID', 'Property Name', 'Full Address', 'Submarket', 'County', 'GLA (SF)', 
                    'Lot Size', 'Year Built', 'Year Renovated', 'Occupancy %', 'Vacant SF', 'NOI', 'Asking Price', 'Price/SF', 
                    'Cap Rate', '# Tenants', 'Anchor Tenant', 'Avg Rent/SF', 'CAM Structure', 'WALT',
                    '% Leases Expiring â‰¤3Y', 'Recent CapEx (Y/N)', 'Traffic Count', 'Highlights'
                ];

                const propertyRows = this.extractedData.properties.map(p => [
                    p.propertyId, p.propertyName, p.fullAddress, p.submarket, p.county, p.gla,
                    p.lotSize, p.yearBuilt, p.yearRenovated, p.occupancyPercent, p.vacantSF, p.noi, p.askingPrice, p.priceSF,
                    p.capRate, p.numTenants, p.anchorTenant, p.avgRentSF, p.camStructure, p.walt,
                    p.leasesExpiringThreeYears, p.recentCapEx, p.trafficCount, p.highlights
                ]);

                const leaseHeaders = [
                    'Comp ID', 'Tenant', 'Sq.Ft.', 'Rent/SF', 'Annual Rent', 'CAM / RE Tax', 'Lease Start-End (raw)',
                    'Lease Start', 'Lease End', 'Lease Duration', 'Years Remaining', 'Effective Rent/SF',
                    'Lease Start-End (Formatted)', 'Property Address', 'Aggregate SF', 'Date Entered', 'Property ID',
                    'Base Term (Months)', 'TI Work Allowance', 'Landlord Rep Brokerage', 'Rent Expires', 
                    'Options Period', 'Options Start Date', 'Option Rent (FMV/Annual Rent)', 'Floor', 'Source'
                ];

                const leaseRows = this.extractedData.leaseComps.map(l => [
                    l.compId, l.tenant, l.sqft, l.rentSF, l.annualRent, l.camRETax, l.leaseStartEndRaw,
                    l.leaseStart, l.leaseEnd, l.leaseDuration, l.yearsRemaining, l.effectiveRentSF,
                    l.leaseStartEndFormatted, l.propertyAddress, l.aggregateSF, l.dateEntered, l.propertyId,
                    l.baseTermMonths, l.tiWorkAllowance, l.landlordRepBrokerage, l.rentExpires,
                    l.optionsPeriod, l.optionsStartDate, l.optionRent, l.floor, l.source
                ]);

                const propertyCSV = this.formatCSV(propertyHeaders, propertyRows);
                const leaseCSV = this.formatCSV(leaseHeaders, leaseRows);
                const csvContent = 'Property Database\n' + propertyCSV + '\n\nLease Comps\n' + leaseCSV;

                this.downloadViaDataURI(csvContent, filename);
            }

            downloadViaDataURI(content, filename) {
                try {
                    const base64Content = btoa(unescape(encodeURIComponent(content)));
                    const dataURI = 'data:text/csv;charset=utf-8;base64,' + base64Content;
                    
                    const status = document.getElementById('status');
                    status.innerHTML = `
                        <div style="margin-bottom: 16px; font-weight: 500; color: #333; font-size: 14px;">
                            File ready for download
                        </div>
                        
                        <div style="margin-bottom: 16px; text-align: center;">
                            <a href="${dataURI}" download="${filename}" class="download-link">
                                ${filename}
                            </a>
                            <div style="font-size: 12px; color: #888; margin-top: 8px; font-weight: 400;">
                                Right-click and select "Save Link As..."
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <details style="cursor: pointer;">
                                <summary style="font-size: 12px; color: #666; font-weight: 400; outline: none;">
                                    Alternative methods
                                </summary>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
                                    <button onclick="tool.copyToClipboard(\`${content.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`, '${filename}')" 
                                            style="padding: 6px 12px; background: #fff; border: 1px solid #ddd; 
                                                   border-radius: 3px; cursor: pointer; margin-right: 8px; font-size: 12px;
                                                   color: #333; transition: all 0.2s ease;">
                                        Copy content
                                    </button>
                                    <button onclick="tool.showTextAreaFallback(\`${content.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`, '${filename}')" 
                                            style="padding: 6px 12px; background: #fff; border: 1px solid #ddd; 
                                                   border-radius: 3px; cursor: pointer; font-size: 12px;
                                                   color: #333; transition: all 0.2s ease;">
                                        Show text
                                    </button>
                                </div>
                            </details>
                        </div>
                        
                        <div style="font-size: 11px; color: #999; text-align: center; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                            ${this.extractedData.properties.length} properties â€¢ ${this.extractedData.leaseComps.length} lease comparables
                        </div>
                    `;
                    status.className = 'status success';
                    status.style.display = 'block';
                    this.updateHeight();
                    
                } catch (error) {
                    this.showTextAreaFallback(content, filename);
                }
            }

            copyToClipboard(content, filename) {
                try {
                    navigator.clipboard.writeText(content).then(() => {
                        alert(`CSV content copied!\n\nPaste into Excel or text editor and save as "${filename}"`);
                    }).catch(() => {
                        this.showTextAreaFallback(content, filename);
                    });
                } catch (error) {
                    this.showTextAreaFallback(content, filename);
                }
            }

            showTextAreaFallback(content, filename) {
                const status = document.getElementById('status');
                status.innerHTML = `
                    <div style="margin-bottom: 8px; font-weight: 500; font-size: 13px;">Copy CSV Content</div>
                    <div style="margin-bottom: 8px; font-size: 12px; color: #666;">
                        Select all, copy, and paste into Excel or text editor
                    </div>
                    <textarea onclick="this.select()" readonly 
                              style="width: 100%; height: 120px; font-family: monospace; 
                                     font-size: 11px; padding: 8px; border: 1px solid #ddd;
                                     border-radius: 3px; margin: 8px 0; resize: vertical;">${content}</textarea>
                `;
                status.className = 'status success';
                status.style.display = 'block';
                this.updateHeight();
            }

            formatCSV(headers, rows) {
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value);
                    if (str.includes(',') || str.includes('\n') || str.includes('\r') || str.includes('"')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };

                let csv = headers.map(escapeCSV).join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(escapeCSV).join(',') + '\n';
                });
                return csv;
            }

            generateUUID() {
                return Math.random().toString(36).substr(2, 8).toUpperCase();
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the tool
        const tool = new RIPCOEmbedTool();

        // Listen for messages from Monday.com
        window.addEventListener('message', (event) => {
            if (event.data.type === 'MONDAY_THEME_CHANGE') {
                // Handle Monday.com theme changes if needed
                console.log('Monday.com theme changed:', event.data.theme);
            }
        });
    </script>
</body>
</html>
